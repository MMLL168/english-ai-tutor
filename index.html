<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å°å­¸å ‚ (Ver 17.0 Hybrid DB)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background-color: #f0f9ff; }
        .hidden { display: none !important; } 
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); }
        .timer-bar { transition: width 1s linear; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .correct-flash { animation: flashGreen 0.5s; }
        @keyframes flashGreen { 0% { background-color: #dcfce7; } 50% { background-color: #86efac; } 100% { background-color: #dcfce7; } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .speaking-icon { animation: pulse-speak 1s infinite; color: #4f46e5; }
        @keyframes pulse-speak { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen font-sans">

    <div id="screen-login" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-800/50 backdrop-blur-sm">
        <div class="glass p-8 rounded-3xl shadow-2xl w-full max-w-md text-center border border-white">
            <div class="w-20 h-20 bg-indigo-600 text-white rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-lg">
                <i class="fa-solid fa-database"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-800">è‹±æ–‡å°å­¸å ‚</h1>
            <p class="text-indigo-600 font-bold text-sm mt-2 mb-6 bg-indigo-50 inline-block px-3 py-1 rounded-full">Ver 17.0 Hybrid DB</p>

            <div class="space-y-4 text-left">
                <div>
                    <label class="font-bold text-slate-600 text-sm">å¸³è™Ÿ</label>
                    <input type="text" id="login-user" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none font-bold text-lg" placeholder="Dora">
                </div>
                <div>
                    <label class="font-bold text-slate-600 text-sm">å¯†ç¢¼</label>
                    <input type="password" id="login-pass" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none font-bold text-lg" placeholder="PIN">
                </div>
                <div id="login-error" class="hidden text-red-500 text-center font-bold bg-red-50 p-2 rounded">å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</div>
                <button onclick="sys_login()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-transform active:scale-95">ç™»å…¥ Login</button>
            </div>
        </div>
    </div>

    <div id="screen-setup" class="hidden fixed inset-0 z-[60] bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl w-full max-w-md shadow-2xl text-center h-[85vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-2">ç³»çµ±è¨­å®š</h3>
            <div class="text-left mb-6">
                <label class="font-bold text-slate-600 text-sm block mb-1">1. Gemini API Key</label>
                <input type="password" id="api-key-input" placeholder="è²¼ä¸Š API Key..." class="w-full p-3 border-2 border-gray-200 rounded-xl outline-none focus:border-indigo-500 font-mono text-sm">
            </div>
            <div class="text-left mb-6">
                <label class="font-bold text-slate-600 text-sm block mb-1">2. Google Sheet URL (é¡Œåº«/éŒ¯é¡Œ)</label>
                <textarea id="gas-url-input" rows="3" class="w-full p-3 border-2 border-gray-200 rounded-xl outline-none focus:border-indigo-500 font-mono text-xs text-slate-500 break-all" placeholder="https://script.google.com/..."></textarea>
                <p class="text-xs text-green-600 mt-1 font-bold"><i class="fa-solid fa-check"></i> é€£çµé¡Œåº«å€‰åº«</p>
            </div>
            <div id="validation-msg" class="hidden mb-4 p-3 rounded text-sm font-bold"></div>
            <button id="btn-validate" onclick="sys_validateKey()" class="w-full py-3 bg-green-500 text-white rounded-xl font-bold shadow mb-3">é©—è­‰ä¸¦å„²å­˜</button>
            <button onclick="sys_cancelSetup()" class="w-full py-3 bg-gray-100 text-gray-500 rounded-xl font-bold">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="screen-settings" class="hidden fixed inset-0 z-40 bg-indigo-50 min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-3xl shadow-xl p-8 border border-indigo-100">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black text-slate-800"><i class="fa-solid fa-sliders text-indigo-500 mr-2"></i> æ¸¬é©—è¨­å®š</h2>
                <button onclick="sys_editSettings()" class="text-xs border border-indigo-200 bg-indigo-50 px-3 py-1 rounded-full text-indigo-600 font-bold hover:bg-indigo-100"><i class="fa-solid fa-gear mr-1"></i> è¨­å®š</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label class="block font-bold text-slate-600 mb-2">é›£åº¦ç­‰ç´š</label>
                    <select id="set-diff" class="w-full p-3 border-2 rounded-xl font-bold text-slate-700 bg-slate-50"><option value="preschool">ğŸ£ å¹¼å¹¼ç­</option><option value="low">ğŸŒ± ä½å¹´ç´š</option><option value="mid">ğŸŒ¿ ä¸­å¹´ç´š</option><option value="high" selected>ğŸŒ³ é«˜å¹´ç´š</option><option value="grad">ğŸ“ åœ‹å°ç•¢æ¥­</option></select>
                </div>
                <div>
                    <label class="block font-bold text-slate-600 mb-2">å›åˆé¡Œæ•¸</label>
                    <select id="set-count" class="w-full p-3 border-2 rounded-xl font-bold text-slate-700 bg-slate-50"><option value="5">5 é¡Œ</option><option value="10" selected>10 é¡Œ</option><option value="20">20 é¡Œ</option></select>
                </div>
                <div>
                    <label class="block font-bold text-slate-600 mb-2">å€’æ•¸è¨ˆæ™‚</label>
                    <select id="set-timer" class="w-full p-3 border-2 rounded-xl font-bold text-slate-700 bg-slate-50"><option value="0">â™¾ï¸ ä¸é™æ™‚</option><option value="30">30 ç§’</option><option value="15">15 ç§’</option><option value="10">10 ç§’</option></select>
                </div>
                <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border-2 border-slate-200">
                    <label class="font-bold text-slate-700 flex items-center cursor-pointer">
                        <input type="checkbox" id="set-autoplay" class="w-5 h-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 mr-2" checked> <i class="fa-solid fa-volume-high mr-2 text-indigo-500"></i> è‡ªå‹•ç™¼éŸ³
                    </label>
                </div>
            </div>

            <button onclick="game_prepareBatch()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-500 text-white text-2xl font-black rounded-2xl shadow-lg hover:scale-[1.02] transition-transform">é–‹å§‹æ¸¬é©— GO! <i class="fa-solid fa-play ml-2"></i></button>
        </div>
    </div>

    <div id="screen-loading" class="hidden fixed inset-0 z-[50] bg-white/90 flex flex-col items-center justify-center p-4">
        <div class="loader mb-6"></div>
        <h2 class="text-2xl font-black text-slate-800 mb-2">é¡Œåº«æª¢ç´¢ä¸­...</h2>
        <p class="text-slate-500" id="loading-text">Connecting Database...</p>
    </div>

    <div id="screen-game" class="hidden flex-col min-h-screen bg-slate-50">
        <header class="bg-white sticky top-0 z-30 shadow-sm border-b">
            <div class="max-w-3xl mx-auto p-4">
                <div class="flex justify-between items-center mb-2">
                    <button onclick="sys_showScreen('screen-settings')" class="w-10 h-10 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="font-black text-xl">Q <span id="ui-current" class="text-indigo-600">1</span> / <span id="ui-total">10</span></div>
                    <div class="flex items-center gap-2">
                        <div id="ui-timer-text" class="font-mono font-bold text-slate-400 text-sm"></div>
                        <div class="bg-amber-100 text-amber-700 px-4 py-1 rounded-full font-bold"><i class="fa-solid fa-star"></i> <span id="ui-score">0</span></div>
                    </div>
                </div>
                <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden"><div id="ui-timer-bar" class="h-full bg-indigo-500 w-full timer-bar"></div></div>
            </div>
        </header>
        <main class="flex-grow p-4 flex flex-col items-center">
            <div class="w-full max-w-3xl">
                <div class="flex overflow-x-auto gap-2 mb-6 pb-2 scrollbar-hide" id="tab-container"></div>
                <div id="game-area" class="bg-white rounded-3xl shadow-lg min-h-[400px] flex flex-col justify-center items-center p-6 relative border border-slate-200"></div>
            </div>
        </main>
    </div>

    <div id="screen-summary" class="hidden fixed inset-0 z-[55] bg-slate-900/90 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 text-center">
            <div class="w-24 h-24 bg-yellow-100 text-yellow-500 rounded-full flex items-center justify-center text-5xl mx-auto mb-4"><i class="fa-solid fa-trophy"></i></div>
            <h2 class="text-3xl font-black text-slate-800 mb-2">æ¸¬é©—çµæŸ</h2>
            <p id="upload-status" class="text-xs text-gray-400 mb-6 h-4">ç­‰å¾…ä¸Šå‚³...</p>
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-green-50 p-3 rounded-xl border border-green-200"><div class="text-green-600 font-black text-2xl" id="end-correct">0</div><div class="text-xs text-green-600 uppercase font-bold">Correct</div></div>
                <div class="bg-red-50 p-3 rounded-xl border border-red-200"><div class="text-red-500 font-black text-2xl" id="end-wrong">0</div><div class="text-xs text-red-500 uppercase font-bold">Wrong</div></div>
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-200"><div class="text-blue-600 font-black text-2xl" id="end-score">0</div><div class="text-xs text-blue-600 uppercase font-bold">Score</div></div>
            </div>
            <button onclick="game_prepareBatch()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl mb-3">å†ç©ä¸€æ¬¡</button>
            <button onclick="sys_showScreen('screen-settings')" class="w-full py-3 bg-slate-100 text-slate-600 font-bold rounded-xl">å›ä¸»é¸å–®</button>
        </div>
    </div>

    <script>
        const USERS = {'Dora':'6721','Admin':'admin'};
        const MODEL = 'gemini-2.0-flash-exp'; 
        const KEY_STORAGE = 'gemini_key_v27';
        const GAS_STORAGE = 'gas_url_v4';
        
        // Default GAS URL
        const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbyYEGJslt_eB3PL0AkXNxa3wBCbGfChEAv0bYJzVFWmTVZe9YQbIGwzTnqJhHV_VLc-Ng/exec";

        let config={diff:'high',total:10,time:0,autoplay:true}, state={qIdx:0,correct:0,wrong:0,score:0,timer:null}, currentMode='vocab', questionBank=[], sentBuffer=[];
        let selectedVoice = null;
        let sheetWarehouse = []; // å„²å­˜å¾ Sheet ä¸‹è¼‰çš„é¡Œåº«

        function initVoices() {
            if (!window.speechSynthesis) return;
            const load = () => {
                const voices = window.speechSynthesis.getVoices();
                selectedVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) || voices.find(v => v.lang === 'en-US') || voices.find(v => v.lang.startsWith('en'));
            };
            load(); window.speechSynthesis.onvoiceschanged = load;
        }

        // --- Core System ---
        function sys_showScreen(id){
            game_stopTimer();
            document.querySelectorAll('[id^="screen-"]').forEach(el=>{el.classList.add('hidden');el.classList.remove('flex')});
            const t=document.getElementById(id);t.classList.remove('hidden');
            if(id!=='screen-game')t.classList.add('flex');else t.classList.add('flex');
        }
        
        function sys_login(){const u=document.getElementById('login-user').value.trim(),p=document.getElementById('login-pass').value.trim();if(USERS[u]&&USERS[u]===p){util_speak('');const k=localStorage.getItem(KEY_STORAGE);if(k)sys_showScreen('screen-settings');else sys_showScreen('screen-setup');initVoices();}else document.getElementById('login-error').classList.remove('hidden')}
        
        function sys_editSettings() {
            const k = localStorage.getItem(KEY_STORAGE);
            const gas = localStorage.getItem(GAS_STORAGE) || DEFAULT_GAS_URL;
            if(k) document.getElementById('api-key-input').value = k;
            document.getElementById('gas-url-input').value = gas;
            sys_showScreen('screen-setup');
        }

        function sys_cancelSetup() {
            if (localStorage.getItem(KEY_STORAGE)) sys_showScreen('screen-settings'); else sys_showScreen('screen-login');
        }

        async function sys_validateKey(){
            const k=document.getElementById('api-key-input').value.trim();
            const gas=document.getElementById('gas-url-input').value.trim();
            const m=document.getElementById('validation-msg'),b=document.getElementById('btn-validate');
            if(!k)return alert("Enter Key");
            b.disabled=true;b.innerText="Testing...";
            try{
                const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${k}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:"Hi"}]}]})});
                if(r.ok){
                    localStorage.setItem(KEY_STORAGE,k);
                    if(gas) localStorage.setItem(GAS_STORAGE, gas);
                    m.innerText="Success!";m.className="mb-4 p-3 rounded text-sm font-bold bg-green-100 text-green-700 block";
                    setTimeout(()=>sys_showScreen('screen-settings'),1000)
                }else throw new Error("Invalid Key");
            }catch(e){
                m.innerText="Fail";m.className="mb-4 p-3 rounded text-sm font-bold bg-red-100 text-red-700 block";b.disabled=false;b.innerText="Retry"
            }
        }
        function sys_resetKey(){if(confirm("Reset?")){localStorage.removeItem(KEY_STORAGE);sys_showScreen('screen-setup')}}
        function sys_getApiKey(){return localStorage.getItem(KEY_STORAGE)}
        function sys_getGasUrl(){return localStorage.getItem(GAS_STORAGE) || DEFAULT_GAS_URL;}

        // --- GAS: Score Upload & Mistake Save ---
        function sys_uploadLog() {
            const gasUrl = sys_getGasUrl();
            const status = document.getElementById('upload-status');
            
            status.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-indigo-500"></i> ä¸Šå‚³æˆç¸¾ä¸­...';
            status.className = "text-sm text-indigo-600 font-bold mb-6 h-4";

            const payload = {
                action: 'log_score', // æŒ‡å®šå‹•ä½œ
                user: document.getElementById('login-user').value,
                difficulty: config.diff,
                mode: currentMode,
                correct: state.correct,
                wrong: state.wrong,
                score: state.score,
                settings: `${config.total}é¡Œ / ${config.time}ç§’`
            };

            fetch(gasUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(() => {
                status.innerHTML = '<i class="fa-solid fa-check-circle"></i> è¨˜éŒ„å·²ä¸Šå‚³';
                status.className = "text-sm text-green-600 font-bold mb-6 h-4";
            }).catch(e => { console.error(e); status.innerText = "ä¸Šå‚³å¤±æ•—"; status.className = "text-sm text-red-400 mb-6 h-4"; });
        }

        function sys_saveMistake(data) {
            const gasUrl = sys_getGasUrl();
            const payload = {
                action: 'save_mistake',
                user: document.getElementById('login-user').value,
                word: data.speak_text, // ç”¨è‹±æ–‡ç•¶ Key
                chinese: data.answer,  // ä¸­æ–‡è§£é‡‹ (è‹¥æ˜¯å…¶ä»–æ¨¡å¼ï¼Œå¯èƒ½è¦èª¿æ•´)
                mode: currentMode
            };
            // èƒŒæ™¯éœé»˜ä¸Šå‚³
            fetch(gasUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        }

        function sys_updateMastery(data) {
            // åªæœ‰åœ¨è¤‡ç¿’æ¨¡å¼æ‰æ›´æ–°
            if (currentMode !== 'review') return;
            const gasUrl = sys_getGasUrl();
            const payload = {
                action: 'update_mastery',
                user: document.getElementById('login-user').value,
                word: data.speak_text
            };
            fetch(gasUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        }

        // --- Data Handling (Hybrid) ---
        
        async function game_prepareBatch() {
            game_stopTimer();
            config.diff=document.getElementById('set-diff').value;
            config.total=parseInt(document.getElementById('set-count').value);
            config.time=parseInt(document.getElementById('set-timer').value);
            config.autoplay=document.getElementById('set-autoplay').checked;

            sys_showScreen('screen-loading');
            const user = document.getElementById('login-user').value;

            // 1. éŒ¯é¡Œè¤‡ç¿’æ¨¡å¼ï¼šå¾ GAS æ‹‰è³‡æ–™
            if (currentMode === 'review') {
                document.getElementById('loading-text').innerText = "ä¸‹è¼‰éŒ¯é¡Œæœ¬...";
                try {
                    const res = await fetch(`${sys_getGasUrl()}?action=get_mistakes&user=${user}`);
                    const data = await res.json();
                    if (!data || data.length === 0) { alert("å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰éŒ¯é¡Œã€‚"); sys_showScreen('screen-settings'); return; }
                    
                    // è½‰æ›æ ¼å¼
                    questionBank = data.map(m => ({
                        type: 'Review',
                        prompt: `è«‹å• [${m.word}] çš„æ„æ€?`,
                        speak_text: m.word,
                        answer: m.chinese,
                        mastery: m.mastery,
                        options: generateOptionsFromWarehouse(m.chinese), // å¾é¡Œåº«è£œé¸é …
                        mode: 'vocab' // é è¨­ç‚ºå–®å­—é¡Œå‹
                    })).slice(0, config.total);
                    
                    game_start();
                } catch (e) {
                    console.error(e); alert("éŒ¯é¡Œä¸‹è¼‰å¤±æ•—"); sys_showScreen('screen-settings');
                }
                return;
            }

            // 2. ä¸€èˆ¬æ¨¡å¼ï¼šå…ˆçœ‹ Sheet å€‰åº«ï¼Œä¸å¤ å†æ‰¾ AI
            document.getElementById('loading-text').innerText = "æª¢ç´¢é¡Œåº« (Google Sheet)...";
            
            // ä¸‹è¼‰é¡Œåº« (å¦‚æœé‚„æ²’ä¸‹è¼‰é)
            if (sheetWarehouse.length === 0) {
                try {
                    const res = await fetch(`${sys_getGasUrl()}?action=get_warehouse`);
                    const data = await res.json();
                    if (Array.isArray(data)) sheetWarehouse = data;
                } catch(e) { console.log("Warehouse fetch failed, using AI only"); }
            }

            // å˜—è©¦å¾é¡Œåº«ç”¢ç”Ÿé¡Œç›®
            // é€™è£¡ç°¡åŒ–ï¼šåªè™•ç†å–®å­—æ¨¡å¼çš„é¡Œåº«ï¼Œå…¶ä»–æ¨¡å¼é‚„æ˜¯å« AI
            let fromSheet = [];
            if (currentMode === 'vocab' && sheetWarehouse.length > 0) {
                // éš¨æ©ŸæŒ‘é¡Œ
                const shuffled = [...sheetWarehouse].sort(() => 0.5 - Math.random());
                const picks = shuffled.slice(0, config.total);
                
                fromSheet = picks.map(p => ({
                    type: 'Vocab',
                    prompt: `è«‹å• [${p.word}] çš„ä¸­æ–‡?`,
                    speak_text: p.word,
                    answer: p.chinese,
                    hint: p.level || '',
                    options: generateOptionsFromWarehouse(p.chinese)
                }));
            }

            // å¦‚æœé¡Œåº«å¤ ï¼Œç›´æ¥é–‹å§‹
            if (fromSheet.length >= config.total) {
                questionBank = fromSheet;
                game_start();
                return;
            }

            // é¡Œåº«ä¸å¤ ï¼Œå‘¼å« AI è£œè¶³ (æˆ–å…¨éƒ¨ AI)
            document.getElementById('loading-text').innerText = `é¡Œåº«ä¸è¶³ï¼ŒAI ç”Ÿæˆä¸­...`;
            try {
                const prompt = game_getBatchPrompt(config.total);
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${sys_getApiKey()}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.8 } })
                });

                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                let raw = data.candidates[0].content.parts[0].text.replace(/```json/gi, '').replace(/```/g, '').trim();
                const f = raw.indexOf('['), l = raw.lastIndexOf(']');
                if (f !== -1 && l !== -1) raw = raw.substring(f, l + 1);
                
                questionBank = JSON.parse(raw);
                
                // Post-processing
                questionBank = questionBank.map(q => {
                    if (currentMode === 'vocab') {
                        const engMatch = q.prompt.match(/[a-zA-Z\-\s']+/);
                        q.speak_text = engMatch ? engMatch[0].trim() : q.answer;
                    } else {
                        if(!q.speak_text) q.speak_text = q.answer;
                    }
                    return q;
                });

                game_start();
            } catch(e) {
                console.error(e);
                alert("AI ç”Ÿæˆå¤±æ•—");
                sys_showScreen('screen-settings');
            }
        }

        // Helper: å¾å€‰åº«ç”¢ç”ŸéŒ¯èª¤é¸é …
        function generateOptionsFromWarehouse(correctAnswer) {
            if (sheetWarehouse.length < 4) return ["é¸é …A", "é¸é …B", "é¸é …C", correctAnswer].sort(() => 0.5 - Math.random());
            
            let opts = [correctAnswer];
            while(opts.length < 4) {
                const r = sheetWarehouse[Math.floor(Math.random() * sheetWarehouse.length)].chinese;
                if (!opts.includes(r)) opts.push(r);
            }
            return opts.sort(() => 0.5 - Math.random());
        }

        function game_start() {
            game_stopTimer();
            state={qIdx:0,correct:0,wrong:0,score:0,timer:null};
            document.getElementById('ui-total').innerText=questionBank.length;
            document.getElementById('ui-score').innerText=0;
            sys_showScreen('screen-game');
            game_renderTabs();
            game_renderQuestion();
        }

        function game_end(){
            game_stopTimer();
            document.getElementById('end-correct').innerText=state.correct;
            document.getElementById('end-wrong').innerText=state.wrong;
            document.getElementById('end-score').innerText=state.score;
            sys_showScreen('screen-summary');
            sys_uploadLog(); 
        }

        const MODES=[
            {id:'vocab',name:'ğŸ”¤ å–®å­—'},{id:'grammar',name:'âš–ï¸ æ–‡æ³•'},{id:'usage',name:'ğŸ”— ç”¨æ³•'},
            {id:'sentence',name:'ğŸ§© é€ å¥'},{id:'e2c',name:'ğŸ‡ºğŸ‡¸ è‹±â¡ä¸­'},{id:'c2e',name:'ğŸ‡¹ğŸ‡¼ ä¸­â¡è‹±'},
            {id:'review',name:'ğŸ”¥ éŒ¯é¡Œè¤‡ç¿’'}
        ];

        function game_renderTabs(){
            document.getElementById('tab-container').innerHTML=MODES.map(m => {
                const isReview = m.id === 'review';
                const style = isReview 
                    ? (currentMode===m.id ? 'bg-red-500 text-white border-red-500' : 'bg-red-50 text-red-500 border-red-200')
                    : (currentMode===m.id ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-500 border-slate-200');
                return `<button onclick="game_changeMode('${m.id}')" class="px-4 py-2 rounded-lg font-bold whitespace-nowrap border transition-all ${style}">${m.name}</button>`
            }).join('');
        }
        
        function game_changeMode(m){ if(confirm("Change mode will restart?")) { currentMode=m; game_prepareBatch(); } }

        function game_getBatchPrompt(count){
            let diff="Grade 5-6";
            if(config.diff==='preschool')diff="Preschool";if(config.diff==='low')diff="Grade 1-2";if(config.diff==='mid')diff="Grade 3-4";if(config.diff==='grad')diff="Grade 6+";
            const base=`Role: English Teacher. Level: ${diff}. Mode: ${currentMode}. Task: Generate ${count} UNIQUE questions. Rules: 1.JSON Array. 2.speak_text English ONLY. 3. "answer" MUST be FULL TEXT of correct option (NO A/B/C/D). Schema: {"type":"string","prompt":"string","speak_text":"string","hint":"string","options":["A","B","C","D"],"answer":"string","explain":"string"}`;
            if(currentMode==='vocab')return base+` Content: Vocab MCQ. prompt: "è«‹å• [English Word] çš„ä¸­æ–‡?". options: 4 Chinese.`;
            if(currentMode==='grammar')return base+` Content: Grammar MCQ. prompt: Sentence with ____. options: 4 choices.`;
            if(currentMode==='usage')return base+` Content: Usage MCQ. prompt: Sentence with ____. options: 4 choices.`;
            if(currentMode==='sentence')return base+` Content: Unscramble. prompt: "è«‹é‡çµ„å¥å­". options: 4-8 words. answer: Full sentence.`;
            if(currentMode==='e2c')return base+` Content: Eng->Chi. prompt: Eng sentence. options: null. answer: Chinese.`;
            if(currentMode==='c2e')return base+` Content: Chi->Eng. prompt: Chi sentence. options: null. answer: English.`;
        }

        function game_renderQuestion(){
            if(state.qIdx >= questionBank.length){game_end();return}
            currentData = questionBank[state.qIdx];
            const ga=document.getElementById('game-area');
            const opts=currentData.options||[];
            const speakBtn=`<button onclick="util_speak('${currentData.speak_text.replace(/'/g,"\\'")}', this)" class="ml-2 w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-volume-high"></i></button>`;
            
            let masteryDisplay = (currentMode === 'review') ? `<span class="absolute top-0 right-0 bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded-bl-xl">ç†Ÿç·´åº¦: ${currentData.mastery}/10</span>` : '';

            let html='';
            const qMode = currentData.mode || currentMode; // Handle review mode mixing

            if(qMode!=='sentence'&&qMode!=='e2c'&&qMode!=='c2e'&&opts.length>0){
                html=`<div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">${opts.map(o=>`<button onclick="game_check('${o.replace(/'/g,"\\'")}')" class="p-4 border-2 border-slate-200 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 text-left font-bold text-lg transition-all">${o}</button>`).join('')}</div>`;
            }else if(qMode==='sentence'){
                html=`<div class="w-full space-y-4"><div id="sent-box" onclick="sentBuffer=[];game_renderQuestion()" class="min-h-[60px] p-4 border-2 border-dashed border-slate-300 rounded-xl flex flex-wrap gap-2 justify-center cursor-pointer bg-slate-50"><span class="text-slate-400 text-sm">é»æ“Šæ¸…é™¤</span></div><div class="flex flex-wrap gap-2 justify-center">${opts.map(w=>`<button onclick="sentBuffer.push('${w.replace(/'/g,"\\'")}');this.classList.add('opacity-0','pointer-events-none');updateSentBox()" class="bg-white border-b-4 border-slate-200 active:translate-y-1 active:border-b-0 px-4 py-2 rounded-lg font-bold shadow-sm">${w}</button>`).join('')}</div><button onclick="game_check()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">Check</button></div>`;
            }else{
                html=`<div class="w-full space-y-4"><textarea id="inp-ans" class="w-full p-4 border-2 border-slate-200 rounded-xl outline-none focus:border-indigo-500 text-center text-xl" rows="2" placeholder="è¼¸å…¥ç­”æ¡ˆ"></textarea><button onclick="game_check(document.getElementById('inp-ans').value)" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">Check</button></div>`;
            }
            
            ga.innerHTML=`<div class="w-full max-w-2xl text-center fade-in relative overflow-hidden">${masteryDisplay}<div class="mb-6"><span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs font-bold">${currentData.type || 'Quiz'}</span><div class="flex items-center justify-center mt-2 mb-2"><h2 class="text-2xl md:text-3xl font-black text-slate-800">${currentData.prompt}</h2>${qMode!=='c2e'?speakBtn:''}</div>${currentData.hint?`<p class="text-slate-400 text-sm">Hint: ${currentData.hint}</p>`:''}</div>${html}</div>`;
            document.getElementById('ui-current').innerText = state.qIdx + 1;
            if (config.autoplay) setTimeout(() => { util_speak(currentData.speak_text); }, 600);
            game_startTimer();
        }
        function updateSentBox(){document.getElementById('sent-box').innerHTML=sentBuffer.map(w=>`<span class="bg-indigo-600 text-white px-2 py-1 rounded">${w}</span>`).join(' ')}
        function game_stopTimer() { if(state.timer){clearInterval(state.timer);state.timer=null;} }
        function game_startTimer(){
            game_stopTimer();
            const bar=document.getElementById('ui-timer-bar');
            const txt=document.getElementById('ui-timer-text');
            bar.style.transition='none';bar.style.width='100%';bar.className='h-full w-full bg-indigo-500 timer-bar';
            txt.innerText='';
            if(config.time===0) { txt.innerText="â™¾ï¸"; return; }
            let left=config.time; txt.innerText=left+"s";
            void bar.offsetWidth;
            bar.style.transition=`width ${config.time}s linear`;bar.style.width='0%';
            state.timer=setInterval(()=>{left--;txt.innerText=left+"s";if(left<=3)bar.className='h-full w-full bg-red-500 timer-bar';if(left<=0){game_stopTimer();game_check(null,true)}},1000);
        }

        function game_check(ans,timeout=false){
            game_stopTimer();
            let user=ans;
            const qMode = currentData.mode || currentMode;
            if(qMode==='sentence') user=sentBuffer.join(' ');
            if(timeout) user="";
            
            const clean = s => s ? s.replace(/[^\w\u4e00-\u9fa5]/g,'').toLowerCase().trim() : '';
            const userClean = clean(user);
            const correctClean = clean(currentData.answer);
            
            let isCorrect=false,sim=0;
            if(!timeout){
                if(qMode==='e2c'||qMode==='c2e'){ sim=util_similarity(userClean,correctClean); isCorrect=sim>=0.75; }
                else { 
                    if(currentData.answer.length===1 && ['A','B','C','D'].includes(currentData.answer.toUpperCase())) {
                        const idx = currentData.answer.toUpperCase().charCodeAt(0) - 65;
                        const realAns = currentData.options[idx] ? clean(currentData.options[idx]) : '';
                        isCorrect = userClean === realAns;
                    } else {
                        isCorrect = (userClean === correctClean) || (correctClean.includes(userClean) && userClean.length > 1); 
                    }
                }
            }

            if(isCorrect){
                state.correct++;state.score+=10;document.getElementById('ui-score').innerText=state.score;util_speak(currentData.speak_text);
                if(currentMode === 'review' || currentData.mode) sys_updateMastery(currentData); // Update GAS mastery
            }else{
                state.wrong++; sys_saveMistake(currentData); // Save to GAS
            }
            
            const col=isCorrect?'green':'red'; const title=timeout?'Time\'s up':(isCorrect?'Correct!':'Wrong');
            document.getElementById('game-area').innerHTML=`<div class="w-full max-w-md p-6 rounded-2xl border-4 border-${col}-100 bg-${col}-50 text-center fade-in ${isCorrect?'correct-flash':''}"><h3 class="text-2xl font-black text-${col}-600 mb-4">${title}</h3><div class="bg-white p-4 rounded-xl text-left mb-4 shadow-sm"><p class="text-xs text-slate-400 font-bold">æ­£ç¢ºç­”æ¡ˆ</p><p class="text-lg font-bold text-slate-800 flex justify-between">${currentData.answer}<button onclick="util_speak('${currentData.speak_text.replace(/'/g,"\\'")}')"><i class="fa-solid fa-volume-high text-indigo-500"></i></button></p><hr class="my-2"><p class="text-sm text-slate-600">${currentData.explain||''}</p></div><button onclick="game_next()" class="w-full py-3 bg-slate-800 text-white font-bold rounded-xl">Next</button></div>`;
        }

        function game_next() { state.qIdx++; game_renderQuestion(); }

        function util_speak(txt, btn){
            if(!txt || !window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const u=new SpeechSynthesisUtterance(txt);
            u.lang='en-US'; u.rate=0.8;
            if(selectedVoice) u.voice = selectedVoice;
            if(btn) { btn.classList.add('speaking-icon'); u.onend = () => btn.classList.remove('speaking-icon'); }
            window.speechSynthesis.speak(u);
        }

        function util_similarity(s1,s2){if(s1==s2)return 1.0;if(s1.length==0)return 0.0;let costs=new Array();for(let i=0;i<=s1.length;i++){let lastValue=i;for(let j=0;j<=s2.length;j++){if(i==0)costs[j]=j;else{if(j>0){let newValue=costs[j-1];if(s1.charAt(i-1)!=s2.charAt(j-1))newValue=Math.min(Math.min(newValue,lastValue),costs[j])+1;costs[j-1]=lastValue;lastValue=newValue}}}if(i>0)costs[s2.length]=lastValue}return(s1.length-costs[s2.length])/parseFloat(s1.length)}
        
        window.onload=function(){
            const k = localStorage.getItem(KEY_STORAGE);
            const gas = localStorage.getItem(GAS_STORAGE);
            if(k) document.getElementById('api-key-input').value=k;
            if(gas) document.getElementById('gas-url-input').value=gas;
            else document.getElementById('gas-url-input').value=DEFAULT_GAS_URL;
            sys_showScreen('screen-login'); initVoices();
        };
    </script>
</body>
</html>
