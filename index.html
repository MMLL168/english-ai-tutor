function doPost(e) {
  // 建立一個鎖定，避免多人同時寫入時衝突
  var lock = LockService.getScriptLock();
  lock.tryLock(10000); // 等待 10 秒

  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    // 確保這裡的名字跟您截圖中的 "工作表1" 完全一樣
    var sheet = ss.getSheetByName("工作表1");
    
    if (!sheet) {
      // 如果找不到工作表1，自動建立一個，避免錯誤
      sheet = ss.insertSheet("工作表1");
      sheet.appendRow(["時間", "帳號", "難度", "測驗項目", "答對", "答錯", "總分", "設定詳情"]);
    }

    var rawData = e.postData.contents;
    var data = JSON.parse(rawData);
    
    // 格式化時間 (確保是台灣時間)
    var time = Utilities.formatDate(new Date(), "Asia/Taipei", "yyyy/MM/dd HH:mm:ss");
    
    sheet.appendRow([
      time,
      data.user,
      data.difficulty,
      data.mode,
      data.correct,
      data.wrong,
      data.score,
      data.settings
    ]);
    
    return ContentService.createTextOutput(JSON.stringify({ "result": "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ "result": "error", "error": error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } finally {
    lock.releaseLock();
  }
}
